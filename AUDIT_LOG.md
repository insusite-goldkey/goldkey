# 🔍 골드키 AI 마스터 — 자가검열 감사 로그

---

## ⚠️ 절대명령 (ABSOLUTE DIRECTIVE)

> **"오류점검"** 명령이 내려지면, 아래 4인 감사팀 조건을 100% 적용하여 자동 점검을 실행한다.
> 이 명령은 어떠한 상황에서도 무시되지 않으며, 매 점검 시 아래 4개 관점을 **전부** 다룬다.

### 4인 감사팀 구성 및 점검 범위

| 역할 | 점검 항목 |
|------|-----------|
| ⚖️ **보험 전문 변호사** | 면책조항 적정성, 보험업법 위반 소지, 금융감독원 규정 적합성, 불법 손해사정 여부 |
| 🖥️ **시니어 UX 전문가** | 사용자 흐름 단절, 모바일 최적화 오류, 접근성 문제, UI 혼란·오해 요소 |
| 🔒 **풀스택 개발 보안 전문가** | 세션 취약점, 인증 우회 가능성, 데이터 누출 위험, 예외 처리 누락, XSS·인젝션 방어 |
| 🤖 **AI 로직 설계자** | 프롬프트 인젝션, 분류 오류, 응답 일관성, 금지 키워드 처리, 할루시네이션 방지 |

### 점검 실행 절차

1. `app.py` 전체 코드 구조 파악
2. 위 4개 관점에서 각각 독립적으로 점검
3. 발견된 문제를 아래 **오류 기록** 테이블에 즉시 기록
4. 심각도 분류: 🔴 긴급(즉시 수정) / 🟠 중요(금주 내) / 🟡 개선(다음 스프린트)
5. 수정 완료 시 커밋 해시 기록

---

## 감사팀 프롬프트 (매 감사 시 사용)

```
너는 이제부터 [보험 전문 변호사 / 시니어 UX 전문가 / 풀스택 개발 보안 전문가 / AI 로직 설계자]
4인으로 구성된 감사 팀이다.
현재 개발 중인 '보험 AI 에이전트 앱'의 전체 내용을 아래 4가지 관점에서 엄격히 점검하고 리포트를 제출하라.

1. [보험 전문 변호사] 면책조항, 법률 위반 소지, 보험업법 준수 여부, 금융감독원 규정 적합성
2. [시니어 UX 전문가] 사용자 흐름 단절, 접근성 문제, 모바일 최적화 오류, UI 혼란 요소
3. [풀스택 개발 보안 전문가] 세션 취약점, 인증 우회 가능성, 데이터 누출 위험, 예외 처리 누락
4. [AI 로직 설계자] 프롬프트 인젝션, 분류 오류, 응답 일관성, 금지 키워드 처리 로직
```

---

## 오류 기록

### 2026-02-25

| # | 발생 시각 | 섹션 | 증상 | 원인 | 수정 커밋 |
|---|-----------|------|------|------|-----------|
| 1 | 22:46 | 통합스캔허브(scan_hub) | 관리자 로그인 후 "로그인하라"는 화면 표시 | `auto_recover` / `_run_safe` 예외 처리 시 `st.session_state.clear()`로 `user_id` 포함 전체 삭제 | `76b59e0` |
| 2 | 22:46 | 전체 섹션 | 관리자(이세윤·박보정) 권한 없음으로 표시 | 세션 복구 후 `is_admin`이 재검증되지 않아 소실 | `(현재 수정 중)` |
| 3 | 이전 세션 | 상담 카탈로그 | 관리자 업로드 파일 목록에 미표시 | `user_files` 조회 시 본인 UID로만 필터링 | `932ecfd` |
| 4 | 이전 세션 | 업로드 라이브러리 | 업로드 후 즉시 목록 미반영 | `st.rerun()` 및 캐시 초기화 누락 | `4571383` |
| 5 | 이전 세션 | 라이브러리 박스2 | `기타` 문서가 고객서류로 잘못 분류 | 분류 로직에서 `기타` 처리 누락 | `5ce351d` |

---

## 보안 감사 포인트 (개발 보안 전문가 관점)

- `auto_recover` 세션 전체 초기화 → **로그인 키 보존으로 수정** (`76b59e0`)
- `is_admin` 세션 값 단일 의존 → **매 렌더 재검증으로 강화** (현재 수정)
- `client_name` DB 저장 시 입력 검증 필요 (XSS 방어)
- `user_files` Supabase RLS 정책 — 관리자 파일 공유 시 다른 사용자 접근 허용 범위 재확인 필요

---

## 출력 기능 점검 체크리스트

- [x] `show_result()` 면책조항 포함 출력 — `full_text.encode("utf-8")` 다운로드 정상 (코드 검토 완료)
- [x] `show_result()` 브라우저 인쇄/PDF 저장 — `window.print()` JS `components.html()` 호출 정상
- [x] 출력 내용 텍스트영역 (`print_area_{result_key}`) key 충돌 없음 — result_key별 고유 key 사용
- [x] 다운로드 버튼 (`dl_{result_key}`) key 충돌 없음 — result_key별 고유 key 사용
- [x] 관리자 계정 로그인 시 `👑 관리자` 배지 표시 — `4c7c758` 수정 후 정상
- [ ] 실환경 테스트 필요 — HF Space 재빌드 후 실제 출력 버튼 동작 확인

### 출력 기능 잠재적 주의사항
- `full_text`에 마크다운 기호(`**`, `#`)가 그대로 포함 — 텍스트 파일로는 읽기에 문제없으나, 인쇄 시 마크다운이 렌더링되지 않는 plain text로 출력됨
- `window.print()`는 Streamlit iFrame 구조상 **전체 페이지**를 인쇄함 — 결과 부분만 출력하려면 별도 팝업 창 필요 (workspace/insurance_bot.py의 A4 PDF 방식이 더 적합)

---

## 미결 항목

- Supabase `user_files` 테이블 `client_name` 컬럼 마이그레이션 SQL 실행 필요
  ```sql
  ALTER TABLE user_files ADD COLUMN IF NOT EXISTS client_name TEXT;
  ```
